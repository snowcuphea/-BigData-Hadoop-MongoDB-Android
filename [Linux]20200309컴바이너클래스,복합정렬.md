HDFS는 파일시스템이지만, 물리적으로 확인할 수 있는것이 아니다. (블럭단위로 쪼개져있기때문에)

### MapReduce 프레임워크

* 맵리듀스 : 프레임워크. 대용량 데이터를 처리하기 위함.

* 맵리듀스도 마스터, 슬레이브 구조로 되어있음

* 맵퍼가처리한일을 리듀서한테 전달을 하는데, 매퍼에서 적용한 것을 리듀서에서 바로 처리하면 되는데, 전달시킬 때 네트워크로 전송이 된다.(패킷단위, serialized) 그 때 네트웤 부하에 대한 이슈로 문제가 생길 수 있다.

* 맵리듀스의 기능 : 데이터 분류, 집계하는 것

* 내가 돌리지 않아도 매퍼를 돌리고 나오면 merge되고 sort된다(프레임워크라서 자동으로). (shuffle) 셔플링을 거쳐서 배열로 나온다. 
  shuffle을 커스터마이징해서 내가원하는 형태로 조절한다. mapper를 여러개 만든다던가. 출력을 원하는 형태로 한다던가

![image-20200309094953548](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309094953548.png)

사용한 리듀서 개수만큼 나온다. (r이 리듀스를 의미)



![image-20200309102514738](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309102514738.png)

sts에서 remote controller를 통해 하둡으로 csv파일 옮기고, 옮긴 파일을 /air 폴더를 생성 후 그 안에 넣는다.
다 넣었으면, 홈디렉토리 파일상태로 있는 csv파일의 크기가 부담스럽기 때문에 휴지통으로 버리고 비워준다. (로컬에서도 지워준다. )



---

airdriver 실행

![image-20200309103419227](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309103419227.png)





잡트래커로 진입

http://hadoop01:50030/jobtracker.jsp

![image-20200309104723235](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309104723235.png)

![image-20200309104833656](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309104833656.png)



### 컴바이너 클래스

맵 태스크의 출력데이터는 네트워크를 통해 리듀스 태스크로 전달되는데, 이 과정을 셔플 이라고 한다.

네트워크를 통해 데이터가 전송되기 때문에 전송할 데이터의 크기를 줄일수록 전체 잡의 성능이 좋아진다.

컴바이너의 역할은 다음과 같다. 

* 셔플할 데이터의 크기를 줄인다.
* 매퍼으 출력데이터를 입력데이터로 전달받아 연산 수행
* 미니 리듀서

---

실습

---

리듀서 코드

![image-20200309113108701](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309113108701.png)



그 이후 드라이버 소스에서 컴파이너클래스 등록을 해준다.

**![image-20200309113151712](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309113151712.png)**



하둡에서 실행하려면 jar파일을 실행해야 한다. 

따라서 jar파일로 묶어서 build path에 추가해준다. 



![image-20200309113510761](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309113510761.png)

![image-20200309113537958](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309113537958.png)



![image-20200309113600461](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309113600461.png)

![image-20200309113611358](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309113611358.png)

![image-20200309113750467](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309113750467.png)

![image-20200309113647258](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309113647258.png)

Referenced Library에 mapred-exam.jar보면 생성된 것을 확인할 수 있다.







한 번 실행하고 오류가 뜨면, run configuration해준다.

![image-20200309113317205](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309113317205.png)

---

실행 후 하둡에서 확인해ㅔ보면

컴바이너 쓰기 전에는 : 

![image-20200309114508985](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309114508985.png)

쓰고난 후에는

![image-20200309114527555](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309114527555.png)

차이가 난다. 

이 외에도 여러가지 차이 남 (살펴보기) => 더 효율적이다.



---

### 셔플 커스터마이징

같은것끼리모아야 네트웤 부하가 덜걸리기 때문에 같은것 끼리 모아서 정렬 후 리듀서로 넘긴다. 

이 부분을 내 기준에 의해 원하는 부분을 merge시키고 정렬할 수 있다. 



같은 키를 갖고 있는 

ㅁ머신이 3대가 있으면 각각 받아서 취합하는게 아니라, 같은 종류의 키를 내부에서 모은다. 



![image-20200309133044287](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309133044287.png)

이런 애를 1월부터 12월로 잘 나오게 정렬하려고 한다. 

---

### 정렬 - 보조 정렬 p178

1. 복합키 정의 ( 사용자 정의 키 )
   - WritableComparable 인터페이스 구현 





매퍼에서 데이터 나오면, 

year끼리 계산을 해서 어느 태스크 로 보내야하는지결정되고 모인다. 

메모리 버퍼에 쌓고 같은 것끼리 모아놓은 상태 

#### 

---

### 정렬 실습



#### 복합키

![image-20200309164531202](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309164531202.png)

![image-20200309164558381](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309164558381.png)

WritableComparable을 상속. 그리고 생성자 만들어주고, set,get, tostring등 적어준다.



#### 매퍼

![image-20200309165013683](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309165013683.png)

매퍼를 거쳐서 출력되는 output 타입을 내가 정의한 복합키 형식(CustomKey)으로 해준다.





#### 파티셔너 

![image-20200309163851180](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309163851180.png)





#### 그룹키비교기 

![image-20200309163821502](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309163821502.png)



#### 복합키 비교기

![image-20200309164333946](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309164333946.png)





#### 드라이버

![image-20200309164911371](C:\Users\student\AppData\Roaming\Typora\typora-user-images\image-20200309164911371.png)

정의한 클래스를 드라이버에 등록해준다.





#### 리듀서

